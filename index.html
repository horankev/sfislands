<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Streamlines the Process of Fitting Areal Spatial Models • sfislands</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Streamlines the Process of Fitting Areal Spatial Models">
<meta name="description" content="Helpers for addressing the issue of disconnected spatial units. It allows for convenient adding and removal of neighbourhood connectivity between areal units prior to modelling, with the visual aid of maps. Post-modelling, it reduces the human workload for extracting, tidying and mapping predictions from areal models.">
<meta property="og:description" content="Helpers for addressing the issue of disconnected spatial units. It allows for convenient adding and removal of neighbourhood connectivity between areal units prior to modelling, with the visual aid of maps. Post-modelling, it reduces the human workload for extracting, tidying and mapping predictions from areal models.">
<meta property="og:image" content="https://horankev.github.io/sfislands/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">sfislands</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/article1.html">Guide to sfislands package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/horankev/sfislands/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="sfislands-">sfislands <a class="anchor" aria-label="anchor" href="#sfislands-"></a>
</h1>
</div>
<!-- badges: start -->
<!-- badges: end -->
<p>The goal of <code>sfislands</code> is to make it easier to deal with geographic datasets which contain islands. It does so using a tidy framework in the spirit of Josiah Parry’s <a href="https://sfdep.josiahparry.com/" class="external-link">sfdep</a> package.</p>
<ul>
<li>These do not have to be <em>islands</em> by a traditional <em>land and water</em> geographic definition, but any situation where discontiguous geographical units are present.</li>
</ul>
<p>Such a situation can lead to two issues.</p>
<ul>
<li><p>Firstly, if unaddressed, the presence of such islands or exclaves can make certain types of contiguity-based modelling impossible.</p></li>
<li><p>Secondly, just because two areas are separated by, say, a body of water, this does not necessarily mean that they are to be considered independent of each other.</p></li>
</ul>
<p>This package offers solutions to allow for the inclusion or exclusion of these units within an uncomplicated workflow.</p>
<p>A pre-print of a paper discussing the package is available <a href="https://arxiv.org/abs/2404.09863" class="external-link">here</a>.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the released version from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"sfislands"</span><span class="op">)</span></span></code></pre></div>
<p>You can install the development version of <code>sfislands</code> from <a href="https://github.com/horankev/sfislands" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"horankev/sfislands"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary-of-features">Summary of features<a class="anchor" aria-label="anchor" href="#summary-of-features"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>The initial setting-up of neighbourhood structures can be frustrating for people who are eager to get started with fitting spatial models. This is especially so when the presence of discontiguities within a geographical dataset means that, even having set up a neighbours list, the model will still not run without further awkward data manipulations.</p></li>
<li><p>As an aid to setting up neighbourhood structures, particularly when islands are involved, the package has a function to quickly map any neighbourhood structure for visual inspection. This can also be used to examine the output of <code>sfdep</code> neighbour functions. Such maps can be used to check if the structure makes sense, given the researcher’s knowledge about the geography of the study area.</p></li>
<li><p>If some units have been assigned as neighbours inappropriately, or if we wish to add additional connections, there are functions to allow this to be done in a straightforward and openly reportable way.</p></li>
<li><p>Once an appropriate neighbourhood structure is in place, different types of statistical tests and models can be performed. <code>sfdep</code> contains functionality to perform such tests, and the output from <code>sfislands</code> can be used in its functions.</p></li>
<li><p>The contiguity outputs from <code>sfislands</code> can be directly used to fit different types of (multilevel) (I)CAR models using, for example, the <code>mgcv</code>, <code>brms</code>, <code>stan</code> or <code>INLA</code> packages.</p></li>
<li><p>For <code>mgcv</code> in particular, the predictions of such models can be quite tedious to extract and visualise. <code>sfislands</code> can streamline this workflow from the human side. Furthermore, there is a function to draw maps of these predictions for quick inspection.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="functions-overview">Functions overview<a class="anchor" aria-label="anchor" href="#functions-overview"></a>
</h2>
<p>The following is a brief explanations of the functions contained in the <code>sfislands</code> package and a workflow within which they could be used.</p>
<p>The first group can be seen as pre-functions, designed to create a neighbourhood structure suitable for certain types of models.</p>
<p>Once a model has been fit (using <code>mgcv</code> in this case), the post-functions can be used to extract the predictions.</p>
<div class="section level3">
<h3 id="step-1-set-up-data-pre-functions">Step 1: Set up data (“<em>pre-functions</em>”)<a class="anchor" aria-label="anchor" href="#step-1-set-up-data-pre-functions"></a>
</h3>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>function:</th>
<th>purpose:</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>st_bridges()</strong></td>
<td><em>Create a neighbours list, matrix, or <code>sf</code> dataframe containing a neighbours list or matrix as column “nb”, while accounting for islands.</em></td>
</tr>
<tr class="even">
<td><strong>st_quickmap_nb()</strong></td>
<td><em>Check contiguities visually on map.</em></td>
</tr>
<tr class="odd">
<td><strong>st_check_islands()</strong></td>
<td><em>Check assignment of island contiguities in a dataframe.</em></td>
</tr>
<tr class="even">
<td><strong>st_force_join_nb()</strong></td>
<td><em>Enforce changes to any connections.</em></td>
</tr>
<tr class="odd">
<td><strong>st_force_cut_nb()</strong></td>
<td><em>Enforce changes to any connections.</em></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="step-2-create-model">Step 2: Create model<a class="anchor" aria-label="anchor" href="#step-2-create-model"></a>
</h3>
<p>Use the output of <code><a href="reference/st_bridges.html">st_bridges()</a></code> as both the data and neighbourhood inputs for a model using, for example, <code>mgcv</code>, <code>brms</code> or <code>inla</code>.</p>
</div>
<div class="section level3">
<h3 id="step-3-examine-output-post-functions">Step 3: Examine output (“<em>post functions</em>”)<a class="anchor" aria-label="anchor" href="#step-3-examine-output-post-functions"></a>
</h3>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>function:</th>
<th>purpose:</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>st_augment()</strong></td>
<td><em>Augment the original dataframe with model predictions.</em></td>
</tr>
<tr class="even">
<td><strong>st_quickmap_preds()</strong></td>
<td><em>Generate quick maps of these predictions.</em></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<p>The dataset <code>uk_elections</code>, which is provided with the package, is used for the following demonstrations. It is an <code>sf</code> dataset with geometries for each of the 632 Westminster parliamentary constituencies of England, Scotland and Wales in the 2019 general election. For each constituency, it contains socio-economic data from the 2011 census. It also shows the <em>Butler swing</em> between the 2017 and 2019 elections, which is a measure of the change in voter allegiance in favour of the Conservative Party from the Labour Party.</p>
<div class="section level3">
<h3 id="pre-functions-creating-desired-adjacency-structure">Pre-functions: Creating desired adjacency structure<a class="anchor" aria-label="anchor" href="#pre-functions-creating-desired-adjacency-structure"></a>
</h3>
<p>To demonstrate the <code><a href="reference/st_bridges.html">st_bridges()</a></code> function for preparing an adjacency matrix, we focus on Scotland. It is the nation with the highest number of islands. The function, with default arguments, returns a dataframe with an additional column named <code>nb</code>. This column is a named neighbourhood list of class <code>nb</code>. The default neighbourhood structure which it computes is:</p>
<ol style="list-style-type: decimal">
<li><p>for constituencies which are <strong>not islands</strong>, first-order queen contiguity. A constituency is considered to be a neighbour of all of those with which it shares at least a vortex.</p></li>
<li><p>for <strong>islands</strong>, contiguities are assigned to the two nearest constituencies to each island. This number can be altered using the <code>link_islands_k</code> argument.</p></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scotland_df</span> <span class="op">&lt;-</span> <span class="va">uk_election</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span></span>
<span><span class="va">nbsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">scotland_df</span>,</span>
<span>                   row_identifier <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>                   link_islands_k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>This new dataframe has the following form (with a column named <code>nb</code> containing a neighbours list):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nbsf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 10 fields</span></span>
<span><span class="co">#&gt; Geometry type: GEOMETRY</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 92527.68 ymin: 571251.1 xmax: 397261.7 ymax: 812377.5</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB36 / British National Grid</span></span>
<span><span class="co">#&gt;   degree_educated health_not_good     white  con_swing population   region</span></span>
<span><span class="co">#&gt; 1       0.2659346      -0.8699365 0.1441816  7.1285493      99654 Scotland</span></span>
<span><span class="co">#&gt; 2       1.6283752      -1.7731408 0.3038995  2.9732599      93197 Scotland</span></span>
<span><span class="co">#&gt; 3      -1.3538678       0.8155333 0.6963927 -0.2362672      85845 Scotland</span></span>
<span><span class="co">#&gt; 4      -0.6852759      -0.6765349 0.7250742  1.7350840      86004 Scotland</span></span>
<span><span class="co">#&gt; 5       0.2535023      -0.3624242 0.7174423  3.9062703      88166 Scotland</span></span>
<span><span class="co">#&gt; 6      -0.6898382       0.6590625 0.7272781  4.4404142      93308 Scotland</span></span>
<span><span class="co">#&gt;     county        constituency_name  country                     nb</span></span>
<span><span class="co">#&gt; 1 Scotland           Aberdeen North Scotland              2, 36, 58</span></span>
<span><span class="co">#&gt; 2 Scotland           Aberdeen South Scotland                  1, 58</span></span>
<span><span class="co">#&gt; 3 Scotland       Airdrie and Shotts Scotland 11, 12, 41, 42, 43, 46</span></span>
<span><span class="co">#&gt; 4 Scotland                    Angus Scotland         15, 16, 54, 58</span></span>
<span><span class="co">#&gt; 5 Scotland          Argyll and Bute Scotland         54, 55, 57, 59</span></span>
<span><span class="co">#&gt; 6 Scotland Ayr, Carrick and Cumnock Scotland         10, 13, 14, 39</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 MULTIPOLYGON (((395379.7 80...</span></span>
<span><span class="co">#&gt; 2 POLYGON ((396214 805849.7, ...</span></span>
<span><span class="co">#&gt; 3 POLYGON ((290854.4 662154.9...</span></span>
<span><span class="co">#&gt; 4 POLYGON ((374164.5 762668.6...</span></span>
<span><span class="co">#&gt; 5 MULTIPOLYGON (((139257.4 64...</span></span>
<span><span class="co">#&gt; 6 MULTIPOLYGON (((246939 6250...</span></span></code></pre></div>
<p>We can inspect (and openly report) what additional contiguities have been added to the standard queen contiguity structure using the function <code><a href="reference/st_check_islands.html">st_check_islands()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/st_check_islands.html">st_check_islands</a></span><span class="op">(</span><span class="va">nbsf</span><span class="op">)</span></span>
<span><span class="co">#&gt;           island_names island_num nb_num                              nb_names</span></span>
<span><span class="co">#&gt; 1 Na h-Eileanan An Iar         47      9 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 2 Na h-Eileanan An Iar         47     51                   Orkney and Shetland</span></span>
<span><span class="co">#&gt; 3 Na h-Eileanan An Iar         47     55               Ross, Skye and Lochaber</span></span>
<span><span class="co">#&gt; 4  Orkney and Shetland         51      9 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 5  Orkney and Shetland         51     47                  Na h-Eileanan An Iar</span></span></code></pre></div>
<p>The overall contiguity structure can be visualised using the function <code><a href="reference/st_quickmap_nb.html">st_quickmap_nb()</a></code>, whose output is shown below on the left.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span>,</span>
<span>                 concavehull <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 nodes <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>                 numericsize <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span>,</span>
<span>  </span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-7-1.png" width="100%"></p>
<p>However, it is often the case that each <em>island</em> unit (in this case, constituency) is in fact a multipolygon of islands. To make this clearer, the argument <code>concavehull = TRUE</code> can be chosen. These green boundaries (shown above on the right) around each constituency are for reference purpose only and do not influence the assignment of contiguities. They show which group of <em>islands</em> are considered as one <em>constituency of islands</em>. Furthermore, the argument <code>nodes = "numeric"</code> represents the centroids of each unit with its index number instead of a geometric point. This can be useful for editing the adjacencies, particularly if the researcher is not familiar with the names of the individual spatial units.</p>
<div class="section level4">
<h4 id="editing-contiguities">Editing contiguities<a class="anchor" aria-label="anchor" href="#editing-contiguities"></a>
</h4>
<p>A researcher can now use domain knowledge or a particular hypothesis to edit these contiguities. For instance, we may not be happy with the connection between 47 (Na h-Eileanan An Iar) and 51 (Orkney and Shetland) and wish to remove it. We might instead feel that it is important for 47 and 5 to be considered neighbours. This can be easily achieved, as shown below, using the <code><a href="reference/st_force_cut_nb.html">st_force_cut_nb()</a></code> and <code><a href="reference/st_force_join_nb.html">st_force_join_nb()</a></code> functions. The spatial units whose relationships we wish to change can be referenced by name or by index number.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">uk_election</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span>,</span>
<span>                   row_identifier <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>                   link_islands_k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="reference/st_force_cut_nb.html">st_force_cut_nb</a></span><span class="op">(</span><span class="st">"Na h-Eileanan An Iar"</span>, <span class="st">"Orkney and Shetland"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="reference/st_force_join_nb.html">st_force_join_nb</a></span><span class="op">(</span><span class="fl">47</span>, <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>The results of these changes as visualised in map form are shown below:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span>,</span>
<span>                 concavehull <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 nodes <span class="op">=</span> <span class="st">"numeric"</span>,</span>
<span>                 numericsize <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span><span class="op">)</span>,</span>
<span>  </span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-9-1.png" width="100%"></p>
<p>The above process can be iterated until we are happy that the structure conforms with our hypothesis of connectivity within the study area.</p>
</div>
</div>
<div class="section level3">
<h3 id="modelling--post-functions">Modelling &amp; post-functions<a class="anchor" aria-label="anchor" href="#modelling--post-functions"></a>
</h3>
<p>Having set up a neighbourhood structure and embedded it as a named list or matrix within the original <code>sf</code> dataset as a column named <code>nb</code>, the workflow to generate and visualise predictions from a model (in this case using <code>mgcv</code>) is very straightforward and consists of only 3-4 lines of code.</p>
<p>For example, we can use the <code>mgcv</code> package to generate quite a complicated model with various random intercepts and slopes at region and county level, and additionally, different Markov Random Field ICAR smooths at the constituency level. This is done very quickly by</p>
<ul>
<li>using <code><a href="reference/st_bridges.html">st_bridges()</a></code> to prepare the data,</li>
<li>putting that inside the <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">mgcv::gam()</a></code> formulation, and then</li>
<li>piping into the <code><a href="reference/st_augment.html">st_augment()</a></code> function.</li>
</ul>
<p>This gives the following output, with all of the spatially varying predictions and their standard errors being added as extra columns before the final geometry column:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="va">uk_election</span>, <span class="st">"constituency_name"</span><span class="op">)</span> <span class="co"># decide upon the contiguities and add them to the df</span></span>
<span></span>
<span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">con_swing</span> <span class="op">~</span> </span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">region</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># region level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, <span class="va">degree_educated</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random coefficient</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, by<span class="op">=</span><span class="va">white</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>             data<span class="op">=</span><span class="va">prep_data</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># pipe into function to get estimates</span></span>
<span>  <span class="fu"><a href="reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 20 fields</span></span>
<span><span class="co">#&gt; Geometry type: GEOMETRY</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 264110.4 ymin: 148666.1 xmax: 488768.5 ymax: 812377.5</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB36 / British National Grid</span></span>
<span><span class="co">#&gt;   degree_educated health_not_good      white  con_swing population     region</span></span>
<span><span class="co">#&gt; 1     -1.21794372       2.4694480  0.6393329  8.5917223      66133      Wales</span></span>
<span><span class="co">#&gt; 2      0.04609836       0.5666903  0.6561204  2.2040312      56415      Wales</span></span>
<span><span class="co">#&gt; 3      0.26593462      -0.8699365  0.1441816  7.1285493      99654   Scotland</span></span>
<span><span class="co">#&gt; 4      1.62837520      -1.7731408  0.3038995  2.9732599      93197   Scotland</span></span>
<span><span class="co">#&gt; 5     -1.35386780       0.8155333  0.6963927 -0.2362672      85845   Scotland</span></span>
<span><span class="co">#&gt; 6     -0.21109416      -1.3619136 -0.1675498  5.6993250     103922 South East</span></span>
<span><span class="co">#&gt;           county  constituency_name  country                           nb</span></span>
<span><span class="co">#&gt; 1 West Glamorgan           Aberavon    Wales  80, 157, 371, 419, 451, 547</span></span>
<span><span class="co">#&gt; 2          Clwyd          Aberconwy    Wales                 12, 141, 181</span></span>
<span><span class="co">#&gt; 3       Scotland     Aberdeen North Scotland                  4, 239, 595</span></span>
<span><span class="co">#&gt; 4       Scotland     Aberdeen South Scotland                       3, 595</span></span>
<span><span class="co">#&gt; 5       Scotland Airdrie and Shotts Scotland 142, 156, 309, 327, 332, 369</span></span>
<span><span class="co">#&gt; 6      Hampshire          Aldershot  England            70, 395, 517, 544</span></span>
<span><span class="co">#&gt;   random.effect.region random.effect.county</span></span>
<span><span class="co">#&gt; 1           0.07736634           -0.0889861</span></span>
<span><span class="co">#&gt; 2           0.07736634           -0.1062061</span></span>
<span><span class="co">#&gt; 3          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 4          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 5          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 6          -0.60617303            0.2472990</span></span>
<span><span class="co">#&gt;   random.effect.degree_educated|county mrf.smooth.constituency_name</span></span>
<span><span class="co">#&gt; 1                           -3.0504238                   0.08001029</span></span>
<span><span class="co">#&gt; 2                           -1.6077523                   0.10070833</span></span>
<span><span class="co">#&gt; 3                           -0.1165337                  -0.30112582</span></span>
<span><span class="co">#&gt; 4                           -0.1165337                  -0.30111510</span></span>
<span><span class="co">#&gt; 5                           -0.1165337                  -0.34218741</span></span>
<span><span class="co">#&gt; 6                           -2.0453936                   0.01698329</span></span>
<span><span class="co">#&gt;   mrf.smooth.white|constituency_name se.random.effect.region</span></span>
<span><span class="co">#&gt; 1                          0.9971918               0.5881627</span></span>
<span><span class="co">#&gt; 2                          1.2785329               0.5881627</span></span>
<span><span class="co">#&gt; 3                          1.2800763               0.6985112</span></span>
<span><span class="co">#&gt; 4                          1.2799615               0.6985112</span></span>
<span><span class="co">#&gt; 5                          1.7736548               0.6985112</span></span>
<span><span class="co">#&gt; 6                         -0.1353957               0.5113682</span></span>
<span><span class="co">#&gt;   se.random.effect.county se.random.effect.degree_educated|county</span></span>
<span><span class="co">#&gt; 1               0.4400444                               1.0549478</span></span>
<span><span class="co">#&gt; 2               0.4432314                               1.7152822</span></span>
<span><span class="co">#&gt; 3               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 4               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 5               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 6               0.3825063                               0.6696364</span></span>
<span><span class="co">#&gt;   se.mrf.smooth.constituency_name se.mrf.smooth.white|constituency_name</span></span>
<span><span class="co">#&gt; 1                       0.3101948                             0.7308175</span></span>
<span><span class="co">#&gt; 2                       0.2039813                             0.4377840</span></span>
<span><span class="co">#&gt; 3                       0.5769227                             1.0462122</span></span>
<span><span class="co">#&gt; 4                       0.5769674                             1.0463117</span></span>
<span><span class="co">#&gt; 5                       0.4265664                             0.7384490</span></span>
<span><span class="co">#&gt; 6                       0.1762707                             0.2423523</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 POLYGON ((290786.3 202886.7...</span></span>
<span><span class="co">#&gt; 2 POLYGON ((283209.3 381440.5...</span></span>
<span><span class="co">#&gt; 3 MULTIPOLYGON (((395379.7 80...</span></span>
<span><span class="co">#&gt; 4 POLYGON ((396214 805849.7, ...</span></span>
<span><span class="co">#&gt; 5 POLYGON ((290854.4 662154.9...</span></span>
<span><span class="co">#&gt; 6 POLYGON ((485408.1 159918.6...</span></span></code></pre></div>
<p>The predictions can be quickly visualised using <code><a href="reference/st_quickmap_preds.html">st_quickmap_preds()</a></code>. As this function generates a list of <code>ggplots</code>, they can be conveniently visualised using the <code>ggarrange()</code> function from the <code>ggpubr</code> package.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">plots</span>, legend <span class="op">=</span> <span class="st">"none"</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-11-1.png" width="100%"></p>
<p>To emphasise the simplicity of the process, the a modified version of the following sequence of commands will generate a series of plots of all of the spatially varying elements of a model defined in <code>mgcv</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">gam</span><span class="op">(</span><span class="va">...</span>, data <span class="op">=</span> <span class="va">prep_data</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>It is also possible to conduct the same kind of augmenting and plotting of models generated using the <code>lme4</code> and <code>nlme</code> packages.</p>
<p>Further information and vignettes containing more detailed examples are available <a href="https://horankev.github.io/sfislands/">here</a>.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=sfislands" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/horankev/sfislands/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/horankev/sfislands/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing sfislands</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Kevin Horan <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0009-0003-9378-0084" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Katarina Domijan <br><small class="roles"> Author, thesis advisor </small> <a href="https://orcid.org/0000-0002-4268-2236" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Chris Brunsdon <br><small class="roles"> Author, thesis advisor </small> <a href="https://orcid.org/0000-0003-4254-1780" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Horan, Katarina Domijan, Chris Brunsdon.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
