<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Guide to sfislands package • sfislands</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Guide to sfislands package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sfislands</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/article1.html">Guide to sfislands package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/horankev/sfislands/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Guide to sfislands package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/horankev/sfislands/blob/main/vignettes/articles/article1.Rmd" class="external-link"><code>vignettes/articles/article1.Rmd</code></a></small>
      <div class="d-none name"><code>article1.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="in-brief">In brief<a class="anchor" aria-label="anchor" href="#in-brief"></a>
</h2>
<p>The goal of <code>sfislands</code> is to make it easier to deal with
geographic datasets which contain islands. It does so using a tidy
framework in the spirit of Josiah Parry’s <a href="https://sfdep.josiahparry.com/" class="external-link">sfdep</a> package.</p>
<ul>
<li>These do not have to be “literal” islands but any situation where
discontiguous geographical units are present.</li>
</ul>
<p>Such a situation can lead to two issues.</p>
<ul>
<li><p>Firstly, if unaddressed, the presence of such islands or exclaves
can make certain types of contiguity-based modelling
impossible.</p></li>
<li><p>Secondly, just because two areas are separated by, say, a body of
water, this does not necessarily mean that they are to be considered
independent of each other.</p></li>
</ul>
<p>This package offers solutions to allow for the inclusion or exclusion
of these units within an uncomplicated workflow.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>You can install the development version of <code>sfislands</code>
from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"horankev/sfislands"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="summary-of-features">Summary of features<a class="anchor" aria-label="anchor" href="#summary-of-features"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>The initial setting up neighbourhood structures can be
frustrating for people who are eager to get started with fitting spatial
models. This is especially so when the presence of discontiguities
within a geographical dataset means that, even having set up a
neighbours list, the model will still not run without further awkward
data manipulations.</p></li>
<li><p>As an aid to setting up neighbourhood structures, particularly
when islands are involved, the package has a function to quickly map any
neighbourhood structure for visual inspection. This can also be used to
examine the output of <code>sfdep</code> neighbour functions. Such maps
can be used to check if the structure makes sense, given the
researcher’s knowledge about the geography of the study area.</p></li>
<li><p>If there are some neighbours assigned which are not appropriate,
or if you wish to add additional ones, there are functions to allow this
to be done in a straightforward and openly reportable way.</p></li>
<li><p>Once an appropriate neighbourhood structure is in place,
different types of statistical tests and models can be performed.
<code>sfdep</code> contains functionality to perform such test, and the
output from <code>sfislands</code> can be used in its
functions.</p></li>
<li><p>The contiguity outputs from <code>sfislands</code> can be
directly used to fit different types of (multilevel) (I)CAR models
using, for example, the <code>mgcv</code>, <code>brms</code>,
<code>stan</code> or <code>INLA</code> packages.</p></li>
<li><p>For <code>mgcv</code> in particular, the predictions of such
models can be quite tedious to extract and visualise.
<code>sfislands</code> can streamline this workflow from the human side.
Furthermore, there is a function to draw maps of these predictions for
quick inspection.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="functions-overview">Functions overview<a class="anchor" aria-label="anchor" href="#functions-overview"></a>
</h2>
<p>The following is a framework within which the <code>sfislands</code>
functions could be used:</p>
<div class="section level3">
<h3 id="step-1-set-up-data-pre-functions">Step 1: Set up data (“<em>pre-functions</em>”)<a class="anchor" aria-label="anchor" href="#step-1-set-up-data-pre-functions"></a>
</h3>
<table class="table">
<colgroup>
<col width="20%">
<col width="79%">
</colgroup>
<thead><tr class="header">
<th>function:</th>
<th>purpose:</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>st_bridges()</strong></td>
<td><em>Create a neighbours list, matrix, or <code>sf</code> dataframe
containing a neighbours list or matrix as column “nb”, while accounting
for islands.</em></td>
</tr>
<tr class="even">
<td><strong>st_quickmap_nb()</strong></td>
<td><em>Check contiguities visually on map.</em></td>
</tr>
<tr class="odd">
<td><strong>st_check_islands()</strong></td>
<td><em>Check assignment of island contiguities in a
dataframe.</em></td>
</tr>
<tr class="even">
<td><strong>st_manual_join_nb()</strong></td>
<td><em>Make manual changes to any connections.</em></td>
</tr>
<tr class="odd">
<td><strong>st_manual_cut_nb()</strong></td>
<td><em>Make manual changes to any connections.</em></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="step-2-create-model">Step 2: Create model<a class="anchor" aria-label="anchor" href="#step-2-create-model"></a>
</h3>
<p><em>Use the output of <strong>st_bridges()</strong> as both the data
and neighbourhood inputs for a model using, for example,
<code>mgcv</code>, <code>brms</code> or <code>inla</code>.</em></p>
</div>
<div class="section level3">
<h3 id="step-3-examine-output-post-functions">Step 3: Examine output (“<em>post functions</em>”)<a class="anchor" aria-label="anchor" href="#step-3-examine-output-post-functions"></a>
</h3>
<table class="table">
<colgroup>
<col width="23%">
<col width="76%">
</colgroup>
<thead><tr class="header">
<th>function:</th>
<th>purpose:</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>st_augment()</strong></td>
<td><em>Augment the original dataframe with model predictions.</em></td>
</tr>
<tr class="even">
<td><strong>st_quickmap_preds()</strong></td>
<td><em>Generate quick maps of these predictions.</em></td>
</tr>
</tbody>
</table>
<p>Below, we look at these functions in more detail and show them in
operation.</p>
</div>
</div>
<div class="section level2">
<h2 id="pre-functions">Pre-functions<a class="anchor" aria-label="anchor" href="#pre-functions"></a>
</h2>
<p><code>sfdep</code> offers excellent tools for building neighbourhood
structures, among other things. It has a range of functions depending on
how we want to define what <em>neighbour</em> should mean.</p>
<p>However, often when preparing areal spatial data, the presence of
uncontiguous areas (such as islands or exclaves) can create
difficulties. We might also want to account for some hidden contiguities
by allowing bridges, tunnels etc. to render two uncontiguous areas as
neighbours.</p>
<p><code>sfislands</code> provides functions to make this task
easier.</p>
<p>It also provides a number of further helper functions to examine
these neighbourhood structures and use them in models such that the
workflow is streamlined from the human side.</p>
<div class="section level3">
<h3 id="mainland-france-guerry-dataset">Mainland France (<code>guerry</code> dataset)<a class="anchor" aria-label="anchor" href="#mainland-france-guerry-dataset"></a>
</h3>
<p><code>sfislands</code> is intended to be used alongside the
<code>sfdep</code> package. The principal functions from
<code>sfdep</code> for areal data are demonstrated in its vignette using
the <code>guerry</code> (“<em>Essay on the Moral Statistics of
France</em>”) dataset. This data applies to the geographical area of
mainland France as shown below:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">guerry</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>In this French example, the <code>st_islands</code> function
<strong>st_bridges()</strong> produces exactly the same neighbourhood
structure (based on contiguity) as
<strong>sfdep::st_contiguity()</strong>. This can be seen below by
piping these neighbourhood outputs through the <code>st_islands</code>
function <strong>st_quickmap_nb()</strong> which gives a visual
representation of the structure on a map. This function works with
neighbourhoods constructed from any package as long as they are in list
or matrix form.</p>
<p>For <strong>st_quickmap_nb()</strong>, the neighbourhoods should be
within an <code>sf</code> dataframe as a column called “nb”.
<strong>st_bridges()</strong> does this automatically whereas the “nb”
column needs to be added when using <code>sfdep</code> functions.</p>
<div class="section level4">
<h4 id="sfislandsst_bridges">sfislands::st_bridges()<a class="anchor" aria-label="anchor" href="#sfislandsst_bridges"></a>
</h4>
<p>The <code><a href="../reference/st_bridges.html">st_bridges()</a></code> contiguities below, where each
department is considered a neighbour of another if it touches it at
least one point…</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="st">"department"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>… are the same as these from <code>sfdep</code>:</p>
</div>
<div class="section level4">
<h4 id="sfdepst_contiguity">sfdep::st_contiguity()<a class="anchor" aria-label="anchor" href="#sfdepst_contiguity"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>As these maps are produced using <code>ggplot2</code>, their
characteristics can be edited using normal <code>ggplot2</code> syntax
(see 1, below). For convenience, simple arguments are also provided (see
2, below) for changing the core characteristics of the map in a simple
way:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">summarise</span><span class="op">(</span><span class="op">)</span>, </span>
<span>            linewidth <span class="op">=</span> <span class="fl">0.5</span>, colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"st_quickmap_nb()"</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"1. using ggplot syntax"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"aquamarine3"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span>linkcol <span class="op">=</span> <span class="st">"orange"</span>, </span>
<span>                        bordercol <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>                        pointcol <span class="op">=</span> <span class="st">"yellow"</span>, </span>
<span>                        fillcol <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                        linksize <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>                        bordersize <span class="op">=</span> <span class="fl">0.3</span>, </span>
<span>                        pointsize <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                        title <span class="op">=</span> <span class="st">"st_quickmap_nb()"</span>,</span>
<span>                        subtitle <span class="op">=</span> <span class="st">"2. using simplified arguments"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  ncol<span class="op">=</span><span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
<p><code>sfdep</code> offers a number of different types of
neighbourhood structure, a selection of which are shown below. These can
again be conveniently visualised using the
<strong>st_quickmap_nb()</strong> function:</p>
</div>
<div class="section level4">
<h4 id="sfdepst_dist_band">sfdep::st_dist_band()<a class="anchor" aria-label="anchor" href="#sfdepst_dist_band"></a>
</h4>
<p>All areas within a certain distance are considered neighbours:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_geometry</span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu">st_dist_band</span><span class="op">(</span>upper <span class="op">=</span> <span class="fl">150000</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="sfdepst_knn">sfdep::st_knn()<a class="anchor" aria-label="anchor" href="#sfdepst_knn"></a>
</h4>
<p>The k-nearest-neighbours (here, 1) to each area are considered
neighbours:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_geometry</span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu">st_knn</span><span class="op">(</span><span class="fl">1</span>, symmetric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="sfdepst_block_nb">sfdep::st_block_nb()<a class="anchor" aria-label="anchor" href="#sfdepst_block_nb"></a>
</h4>
<p>All areas within a chosen block are considered neighbours:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">code_dept</span></span>
<span><span class="va">regime</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">region</span></span>
<span><span class="va">g</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    nb <span class="op">=</span> <span class="fu">st_block_nb</span><span class="op">(</span><span class="va">regime</span>, <span class="va">id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="sfdepst_lag_cumul">sfdep::st_lag_cumul()<a class="anchor" aria-label="anchor" href="#sfdepst_lag_cumul"></a>
</h4>
<p>Cumulative higher orders of contiguity such as also including
neighbours-of-neighbours:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">g</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">st_nb_lag_cumul</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>However, the <code>sfdep</code> functions above which rely on
contiguity will run into difficulties if we consider the following
geography:</p>
</div>
</div>
<div class="section level3">
<h3 id="england-scotland-wales">England, Scotland &amp; Wales<a class="anchor" aria-label="anchor" href="#england-scotland-wales"></a>
</h3>
<p>In the context of the constituencies of England, Scotland and Wales,
there will be problems due to the presence of islands which will not
feature in a contiguity graph unless we attempt to pick out these
islands and set up a buffer around them. This process is, however,
cumbersome and can induce contiguities which are not intended.</p>
<p>One potential remedy is to entirely exclude islands from the study,
another is to construct a contiguity structure according to your desired
criteria and then set the islands to be contiguous to their closest
<em>k</em> constituencies.</p>
<p><code><a href="../reference/st_bridges.html">st_bridges()</a></code> can do both of these things.</p>
<p>Below is the map in question:</p>
<p>There are island constituencies in the north around Scotland but also
less obvious ones in Wales and England. The constituencies which are
non-contiguous are outlined in red below:</p>
<p><img src="article1_files/figure-html/unnamed-chunk-20-1.png" width="1152"></p>
<p>To incorporate these we use <code><a href="../reference/st_bridges.html">st_bridges()</a></code>. We can set
<code>remove_islands</code> to TRUE if we decide to simply exclude the
islands, or we set <code>link_k_islands</code> to the closest k
constituencies to each islands which we want to bridge.</p>
<div class="section level4">
<h4 id="remove-islands">Remove islands<a class="anchor" aria-label="anchor" href="#remove-islands"></a>
</h4>
<p>Below, with the argument <code>remove_islands</code> set to TRUE, we
simply remove these islands from the dataset entirely.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">uk_election</span>,</span>
<span>                  geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>                  remove_islands <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span>,</span>
<span>                     pointsize<span class="op">=</span><span class="fl">0.05</span>,</span>
<span>                    title <span class="op">=</span> <span class="st">"st_bridges() contiguities"</span>,</span>
<span>                    subtitle <span class="op">=</span> <span class="st">"no island constituencies\n(islands which remain are part of a contiguous constituency)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-21-1.png" width="1152"></p>
</div>
<div class="section level4">
<h4 id="connect-islands">Connect islands<a class="anchor" aria-label="anchor" href="#connect-islands"></a>
</h4>
<p>Alternatively, we can join islands to the nearest, say, 2
constituencies. <code><a href="../reference/st_bridges.html">st_bridges()</a></code> by default returns the
original dataframe augmented with a “nb” column which contains the
contiguities in list form.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">uk_election</span>,</span>
<span>                  geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>                  link_islands_k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span>,</span>
<span>                     pointsize<span class="op">=</span><span class="fl">0.05</span>, </span>
<span>                    title <span class="op">=</span> <span class="st">"st_bridges() contiguities"</span>,</span>
<span>                      subtitle <span class="op">=</span> <span class="st">"islands linked to k=2 nearest constituencies"</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-22-1.png" width="1152"></p>
<p>The neighbourhood structure which is created can be either a named
list (the default) or a named matrix. Different modelling packages have
different requirements for how this information should be presented.
Furthermore, we can choose <code>add_to_dataframe</code> to be TRUE (the
default) to return a dataframe with a column called <code>nb</code>
which contains the named list or matrix. If FALSE, only the
neighbourhood structure itself is returned</p>
<p>These options can be seen in the unexecuted code below:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>nbsf <span class="ot">&lt;-</span> <span class="fu">st_bridges</span>(<span class="at">df =</span> sf_dataframe,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                  <span class="at">geom_col_name =</span> <span class="st">"the column containing the names of the contiguous areas"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                  <span class="at">remove_islands =</span> T<span class="sc">/</span>F,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>                  <span class="at">link_islands_k =</span> <span class="dv">1</span>...n,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                  <span class="at">nb_structure =</span> <span class="st">"list"</span><span class="sc">/</span><span class="st">"matrix"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                  <span class="at">add_to_dataframe =</span> T<span class="sc">/</span>F,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                  <span class="at">title =</span> <span class="st">"title"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>                  <span class="at">subtitle =</span> <span class="st">"subtitle"</span>)</span></code></pre></div>
<p>The neighbourhoods are here in a list form:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nbsf</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span></span>
<span><span class="co">#&gt; $Aberavon</span></span>
<span><span class="co">#&gt; [1]  80 157 371 419 451 547</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Aberconwy</span></span>
<span><span class="co">#&gt; [1]  12 141 181 630</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`Aberdeen North`</span></span>
<span><span class="co">#&gt; [1]   4 239 595</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`Aberdeen South`</span></span>
<span><span class="co">#&gt; [1]   3 595</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`Airdrie and Shotts`</span></span>
<span><span class="co">#&gt; [1] 142 156 309 327 332 369</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Aldershot</span></span>
<span><span class="co">#&gt; [1]  70 395 517 544</span></span></code></pre></div>
<p>But the “nb” column can also be a matrix, and
<code><a href="../reference/st_quickmap_nb.html">st_quickmap_nb()</a></code> will still return the same map:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">uk_election</span>,</span>
<span>                  geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>                  remove_islands <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                  link_islands_k <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  nb_structure <span class="op">=</span> <span class="st">"matrix"</span>,</span>
<span>                  add_to_dataframe <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="va">nbsf</span>,</span>
<span>                     pointsize<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-25-1.png" width="1152"></p>
<p>The matrix neighbourhood structure is now of the following form:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">nbsf</span><span class="op">$</span><span class="va">nb</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co">#&gt;                          [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; Aberavon                    0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Aberconwy                   0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Aberdeen North              0    0    0    1    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Aberdeen South              0    0    1    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Airdrie and Shotts          0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Aldershot                   0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Aldridge-Brownhills         0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Altrincham and Sale West    0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Alyn and Deeside            0    0    0    0    0    0    0    0    0     0</span></span>
<span><span class="co">#&gt; Amber Valley                0    0    0    0    0    0    0    0    0     0</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="editing-the-contiguities">Editing the contiguities<a class="anchor" aria-label="anchor" href="#editing-the-contiguities"></a>
</h3>
<p>There are also functions for manually changing the results of a
neighbourhood construction. It may be the case that you want to add some
additional links or to remove others. For example, you may be aware from
local knowledge of connectivities which are not represented by mere
contiguity of polygons. The presence of tunnels or bridges across a body
of water would be an example of such a situation. The functions
<code><a href="../reference/st_manual_join_nb.html">st_manual_join_nb()</a></code> and <code><a href="../reference/st_manual_cut_nb.html">st_manual_cut_nb()</a></code> do
this.</p>
<div class="section level4">
<h4 id="sfislandst_check_islands">sfisland::st_check_islands()<a class="anchor" aria-label="anchor" href="#sfislandst_check_islands"></a>
</h4>
<p>To make the use of these functions easier and more intuitive, the
function <code><a href="../reference/st_check_islands.html">st_check_islands()</a></code> shows us what contiguities have
been set up for the islands by <code><a href="../reference/st_bridges.html">st_bridges()</a></code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/st_check_islands.html">st_check_islands</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;            island_names island_num nb_num                              nb_names</span></span>
<span><span class="co">#&gt; 1        Isle Of Wight         292    378                       New Forest East</span></span>
<span><span class="co">#&gt; 2        Isle Of Wight         292    379                       New Forest West</span></span>
<span><span class="co">#&gt; 3 Na h-Eileanan An Iar         370    101 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 4 Na h-Eileanan An Iar         370    423                   Orkney and Shetland</span></span>
<span><span class="co">#&gt; 5 Na h-Eileanan An Iar         370    461               Ross, Skye and Lochaber</span></span>
<span><span class="co">#&gt; 6  Orkney and Shetland         423    101 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 7  Orkney and Shetland         423    370                  Na h-Eileanan An Iar</span></span>
<span><span class="co">#&gt; 8             Ynys Mon         630      2                             Aberconwy</span></span>
<span><span class="co">#&gt; 9             Ynys Mon         630     12                                 Arfon</span></span></code></pre></div>
<p>Sometimes, as in this case, certain islands will have more than the
specified k neighbours. This is due to the need for symmetry in the
structure.</p>
</div>
<div class="section level4">
<h4 id="st_manual_join_nb-st_manual_cut_nb">st_manual_join_nb() / st_manual_cut_nb()<a class="anchor" aria-label="anchor" href="#st_manual_join_nb-st_manual_cut_nb"></a>
</h4>
<p>Let us say we want to change some of these. For example, I will cut
the tie between <strong>Isle Of Wight</strong> and <strong>New Forest
East</strong> (using their numbers) and also between <strong>Ynys
Mon</strong> and <strong>Arfon</strong> (using their names):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbsf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_manual_cut_nb.html">st_manual_cut_nb</a></span><span class="op">(</span><span class="fl">292</span>,<span class="fl">378</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_manual_cut_nb.html">st_manual_cut_nb</a></span><span class="op">(</span><span class="st">"Ynys Mon"</span>,<span class="st">"Arfon"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_check_islands.html">st_check_islands</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;            island_names island_num nb_num                              nb_names</span></span>
<span><span class="co">#&gt; 1        Isle Of Wight         292    379                       New Forest West</span></span>
<span><span class="co">#&gt; 2 Na h-Eileanan An Iar         370    101 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 3 Na h-Eileanan An Iar         370    423                   Orkney and Shetland</span></span>
<span><span class="co">#&gt; 4 Na h-Eileanan An Iar         370    461               Ross, Skye and Lochaber</span></span>
<span><span class="co">#&gt; 5  Orkney and Shetland         423    101 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 6  Orkney and Shetland         423    370                  Na h-Eileanan An Iar</span></span>
<span><span class="co">#&gt; 7             Ynys Mon         630      2                             Aberconwy</span></span></code></pre></div>
<p>As extra contiguities can be difficult to distinguish, an extreme
case is shown below to demonstrate <code><a href="../reference/st_manual_join_nb.html">st_manual_join_nb()</a></code>.
<strong>Gower</strong> in South Wales is joined to <strong>St
Ives</strong> in Cornwall and then mapped:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">uk_election</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wales"</span>,<span class="st">"South West"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>           link_islands_k <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="st">"Gower"</span>,<span class="st">"St Ives"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"st_bridges contiguities: Wales &amp; South West"</span>,</span>
<span>                      subtitle <span class="op">=</span> <span class="st">"with additional st_manual_join_nb() for Gower and St Ives"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf_label</span><span class="op">(</span>data<span class="op">=</span><span class="va">uk_election</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">constituency_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Gower"</span>,<span class="st">"St Ives"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                <span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">constituency_name</span><span class="op">)</span>,nudge_x <span class="op">=</span> <span class="op">-</span><span class="fl">30000</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<p>These manual functions can also, of course, be used to edit any of
the previously discussed neighbourhood structures created by
<code>sfdep</code>.</p>
<p>For example, looking just at Scotland we can use
<code><a href="https://sfdep.josiahparry.com/reference/st_nb_lag_cumul.html" class="external-link">sfdep::st_nb_lag_cumul()</a></code> to get first and second degree
neighbours:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">uk_election</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">uk_election</span><span class="op">$</span><span class="va">geometry</span><span class="op">[</span><span class="va">uk_election</span><span class="op">$</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>           <span class="fu">st_nb_lag_cumul</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>This does not include the island constituencies. We can chose to
include them by first using <code><a href="../reference/st_bridges.html">st_bridges()</a></code> with k=2…</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">uk_election</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>             link_islands_k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<p>… and then examining the connections which have been made for
islands:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">uk_election</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span>geom_col_name <span class="op">=</span> <span class="st">"constituency_name"</span>,</span>
<span>             link_islands_k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_check_islands.html">st_check_islands</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;            island_names island_num nb_num                              nb_names</span></span>
<span><span class="co">#&gt; 1 Na h-Eileanan An Iar          47      9 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 2 Na h-Eileanan An Iar          47     51                   Orkney and Shetland</span></span>
<span><span class="co">#&gt; 3 Na h-Eileanan An Iar          47     55               Ross, Skye and Lochaber</span></span>
<span><span class="co">#&gt; 4  Orkney and Shetland          51      9 Caithness, Sutherland and Easter Ross</span></span>
<span><span class="co">#&gt; 5  Orkney and Shetland          51     47                  Na h-Eileanan An Iar</span></span></code></pre></div>
<p>We can then add these island connections to the output of
<code><a href="https://sfdep.josiahparry.com/reference/st_nb_lag_cumul.html" class="external-link">sfdep::st_nb_lag_cumul()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">uk_election</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nb <span class="op">=</span> <span class="fu">st_contiguity</span><span class="op">(</span><span class="va">uk_election</span><span class="op">$</span><span class="va">geometry</span><span class="op">[</span><span class="va">uk_election</span><span class="op">$</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Scotland"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>           <span class="fu">st_nb_lag_cumul</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="fl">47</span>,<span class="fl">9</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="fl">47</span>,<span class="fl">51</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="fl">47</span>,<span class="fl">55</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="fl">51</span>,<span class="fl">9</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_manual_join_nb.html">st_manual_join_nb</a></span><span class="op">(</span><span class="fl">51</span>,<span class="fl">47</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_nb.html">st_quickmap_nb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="modelling-post-functions">Modelling &amp; post-functions<a class="anchor" aria-label="anchor" href="#modelling-post-functions"></a>
</h2>
<p>Having set up a neighbourhood structure and embedded it as a named
list or matrix within the original <code>sf</code> dataset as column
<code>nb</code>, there are some functions to make it easy to quickly
perform ICAR smoothing, augment the original dataframe with these
predictions, and visualise them.</p>
<p>For example, we can use the <code>mgcv</code> package to generate a
Markov Random Field ICAR smooth of poor health across the study area.
This is done very quickly by using <code><a href="../reference/st_bridges.html">st_bridges()</a></code> to prepare
the data, putting that inside the <code>mgcv</code> GAM formulation, and
then piping into the <code><a href="../reference/st_augment.html">st_augment()</a></code> and
<code><a href="../reference/st_quickmap_preds.html">st_quickmap_preds()</a></code> functions.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prep_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="va">uk_election</span>, <span class="st">"constituency_name"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">gam</span><span class="op">(</span><span class="va">health_not_good</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>        data<span class="op">=</span><span class="va">prep_data</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-34-1.png" width="1152"></p>
<p>An equivalent model, this time smoothing over degree_educated, can be
fitted using <code>brms</code>. This package requires the neighbourhoods
to be in matrix form:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prep_data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="va">uk_election</span>, <span class="st">"constituency_name"</span>, nb_structure <span class="op">=</span> <span class="st">"matrix"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">degree_educated</span> <span class="op">~</span> <span class="fu">car</span><span class="op">(</span><span class="va">W</span>, gr<span class="op">=</span><span class="va">constituency_name</span>, type<span class="op">=</span><span class="st">"icar"</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">prep_data2</span>, data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>W<span class="op">=</span><span class="va">prep_data2</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,</span>
<span>           family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,file <span class="op">=</span> <span class="st">"brmsfit_degree"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_data2</span><span class="op">$</span><span class="va">brmsfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>,<span class="va">prep_data2</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">prep_data2</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">brmsfit</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradient2</span><span class="op">(</span>low<span class="op">=</span><span class="st">"firebrick4"</span>,mid<span class="op">=</span><span class="st">"white"</span>,high<span class="op">=</span><span class="st">"darkblue"</span>,midpoint <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<!-- <img src="articles/brms_plot.png" align="centre" height="720"/> -->
<p><img src="brms_plot.png" width="100%"></p>
<p>More complex models with random effects and multiple smooths are also
possible with <code>mgcv</code> and the <code><a href="../reference/st_augment.html">st_augment()</a></code> and
<code><a href="../reference/st_quickmap_preds.html">st_quickmap_preds()</a></code> functions can handle these and label
the columns and maps which are generated appropriately. This is shown
below with a model of swing in the 2019 election:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prep_data3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="va">uk_election</span>, <span class="st">"constituency_name"</span><span class="op">)</span> <span class="co"># decide upon the contiguities and add them to the df</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">con_swing</span> <span class="op">~</span> </span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">region</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># region level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, <span class="va">degree_educated</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random coefficient</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data3</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, by<span class="op">=</span><span class="va">white</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data3</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>             data<span class="op">=</span><span class="va">prep_data3</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># pipe into function to get estimates</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># pipe into this for visualisation</span></span>
<span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">model</span>, legend <span class="op">=</span> <span class="st">"none"</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-38-1.png" width="1152"></p>
<p>To see the estimates returned:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">gam</span><span class="op">(</span><span class="va">con_swing</span> <span class="op">~</span> </span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">region</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># region level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random intercept</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">county</span>, <span class="va">degree_educated</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random coefficient</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data3</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>               <span class="fu">s</span><span class="op">(</span><span class="va">constituency_name</span>, by<span class="op">=</span><span class="va">white</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                 xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data3</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, <span class="co"># ICAR constituency ICAR varying coefficients</span></span>
<span>             data<span class="op">=</span><span class="va">prep_data3</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 20 fields</span></span>
<span><span class="co">#&gt; Geometry type: GEOMETRY</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 264110.4 ymin: 148666.1 xmax: 488768.5 ymax: 812377.5</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB36 / British National Grid</span></span>
<span><span class="co">#&gt;   degree_educated health_not_good      white  con_swing population     region</span></span>
<span><span class="co">#&gt; 1     -1.21794372       2.4694480  0.6393329  8.5917223      66133      Wales</span></span>
<span><span class="co">#&gt; 2      0.04609836       0.5666903  0.6561204  2.2040312      56415      Wales</span></span>
<span><span class="co">#&gt; 3      0.26593462      -0.8699365  0.1441816  7.1285493      99654   Scotland</span></span>
<span><span class="co">#&gt; 4      1.62837520      -1.7731408  0.3038995  2.9732599      93197   Scotland</span></span>
<span><span class="co">#&gt; 5     -1.35386780       0.8155333  0.6963927 -0.2362672      85845   Scotland</span></span>
<span><span class="co">#&gt; 6     -0.21109416      -1.3619136 -0.1675498  5.6993250     103922 South East</span></span>
<span><span class="co">#&gt;           county  constituency_name  country                           nb</span></span>
<span><span class="co">#&gt; 1 West Glamorgan           Aberavon    Wales  80, 157, 371, 419, 451, 547</span></span>
<span><span class="co">#&gt; 2          Clwyd          Aberconwy    Wales                 12, 141, 181</span></span>
<span><span class="co">#&gt; 3       Scotland     Aberdeen North Scotland                  4, 239, 595</span></span>
<span><span class="co">#&gt; 4       Scotland     Aberdeen South Scotland                       3, 595</span></span>
<span><span class="co">#&gt; 5       Scotland Airdrie and Shotts Scotland 142, 156, 309, 327, 332, 369</span></span>
<span><span class="co">#&gt; 6      Hampshire          Aldershot  England            70, 395, 517, 544</span></span>
<span><span class="co">#&gt;   random.effect.region random.effect.county</span></span>
<span><span class="co">#&gt; 1           0.07736634           -0.0889861</span></span>
<span><span class="co">#&gt; 2           0.07736634           -0.1062061</span></span>
<span><span class="co">#&gt; 3          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 4          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 5          -1.69257542           -0.2986088</span></span>
<span><span class="co">#&gt; 6          -0.60617303            0.2472990</span></span>
<span><span class="co">#&gt;   random.effect.degree_educated|county mrf.smooth.constituency_name</span></span>
<span><span class="co">#&gt; 1                           -3.0504238                   0.08001029</span></span>
<span><span class="co">#&gt; 2                           -1.6077523                   0.10070833</span></span>
<span><span class="co">#&gt; 3                           -0.1165337                  -0.30112582</span></span>
<span><span class="co">#&gt; 4                           -0.1165337                  -0.30111510</span></span>
<span><span class="co">#&gt; 5                           -0.1165337                  -0.34218741</span></span>
<span><span class="co">#&gt; 6                           -2.0453936                   0.01698329</span></span>
<span><span class="co">#&gt;   mrf.smooth.white|constituency_name se.random.effect.region</span></span>
<span><span class="co">#&gt; 1                          0.9971918               0.5881627</span></span>
<span><span class="co">#&gt; 2                          1.2785329               0.5881627</span></span>
<span><span class="co">#&gt; 3                          1.2800763               0.6985112</span></span>
<span><span class="co">#&gt; 4                          1.2799615               0.6985112</span></span>
<span><span class="co">#&gt; 5                          1.7736548               0.6985112</span></span>
<span><span class="co">#&gt; 6                         -0.1353957               0.5113682</span></span>
<span><span class="co">#&gt;   se.random.effect.county se.random.effect.degree_educated|county</span></span>
<span><span class="co">#&gt; 1               0.4400444                               1.0549478</span></span>
<span><span class="co">#&gt; 2               0.4432314                               1.7152822</span></span>
<span><span class="co">#&gt; 3               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 4               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 5               0.4500975                               0.2933430</span></span>
<span><span class="co">#&gt; 6               0.3825063                               0.6696364</span></span>
<span><span class="co">#&gt;   se.mrf.smooth.constituency_name se.mrf.smooth.white|constituency_name</span></span>
<span><span class="co">#&gt; 1                       0.3101948                             0.7308175</span></span>
<span><span class="co">#&gt; 2                       0.2039813                             0.4377840</span></span>
<span><span class="co">#&gt; 3                       0.5769227                             1.0462122</span></span>
<span><span class="co">#&gt; 4                       0.5769674                             1.0463117</span></span>
<span><span class="co">#&gt; 5                       0.4265664                             0.7384490</span></span>
<span><span class="co">#&gt; 6                       0.1762707                             0.2423523</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 POLYGON ((290786.3 202886.7...</span></span>
<span><span class="co">#&gt; 2 POLYGON ((283209.3 381440.5...</span></span>
<span><span class="co">#&gt; 3 MULTIPOLYGON (((395379.7 80...</span></span>
<span><span class="co">#&gt; 4 POLYGON ((396214 805849.7, ...</span></span>
<span><span class="co">#&gt; 5 POLYGON ((290854.4 662154.9...</span></span>
<span><span class="co">#&gt; 6 POLYGON ((485408.1 159918.6...</span></span></code></pre></div>
<div class="section level3">
<h3 id="back-to-the-guerry-dataset">Back to the <code>guerry</code> dataset<a class="anchor" aria-label="anchor" href="#back-to-the-guerry-dataset"></a>
</h3>
<p>Returning to the dataset used in <code>sfdep</code>, we can easily
create a smooth of suicides in France in 1830 as follows. Since there
are no islands, we use <code><a href="../reference/st_bridges.html">st_bridges()</a></code> and it will function
like <code>sfdep:st_contiguity()</code> except that it automatically
adds a neighbourhood ‘nb’ column to the dataframe.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_data4</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="st">"department"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod4</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">suicides</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">department</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data4</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">80</span><span class="op">)</span>,</span>
<span>            data<span class="op">=</span><span class="va">prep_data4</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist<span class="op">=</span><span class="va">mod4</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
<p>Or fit a more complex mixed model:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep_data5</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_bridges.html">st_bridges</a></span><span class="op">(</span><span class="st">"department"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model5</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">donations</span> <span class="op">~</span> </span>
<span>                <span class="fu">s</span><span class="op">(</span><span class="va">region</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                <span class="fu">s</span><span class="op">(</span><span class="va">region</span>, <span class="va">crime_prop</span>, bs<span class="op">=</span><span class="st">"re"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># county level random coefficient</span></span>
<span>                <span class="fu">s</span><span class="op">(</span><span class="va">department</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                  xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data5</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="co"># ICAR constituency level varying coefficents</span></span>
<span>                <span class="fu">s</span><span class="op">(</span><span class="va">department</span>, by<span class="op">=</span><span class="va">infants</span>, bs<span class="op">=</span><span class="st">'mrf'</span>, </span>
<span>                  xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nb<span class="op">=</span><span class="va">prep_data5</span><span class="op">$</span><span class="va">nb</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, <span class="co"># ICAR constituency level varying coefficents</span></span>
<span>              data<span class="op">=</span><span class="va">prep_data5</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/st_augment.html">st_augment</a></span><span class="op">(</span><span class="va">prep_data5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># pipe into function to get estimates</span></span>
<span>  <span class="fu"><a href="../reference/st_quickmap_preds.html">st_quickmap_preds</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># pipe into this for visualisation</span></span>
<span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">model5</span>, legend <span class="op">=</span> <span class="st">"none"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="article1_files/figure-html/unnamed-chunk-41-1.png" width="1152"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Horan, Katarina Domijan, Chris Brunsdon.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
